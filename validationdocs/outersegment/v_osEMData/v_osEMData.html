
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>v_osEMData</title><meta name="generator" content="MATLAB 9.0"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2016-12-18"><meta name="DC.source" content="v_osEMData.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; } 

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h2>Contents</h2><div><ul><li><a href="#2">Function implementing the isetbio validation code</a></li><li><a href="#4">Init</a></li><li><a href="#5">Load measured outer segment data.  usec time base</a></li><li><a href="#6">Linear model</a></li><li><a href="#7">Biophys model</a></li><li><a href="#8">Handle initial offsets</a></li><li><a href="#9">Compute RMS error</a></li><li><a href="#10">Plot the two calculations and compare against measured data.</a></li><li><a href="#11">Save validation data</a></li><li><a href="#13">Helper functions</a></li></ul></div><pre class="codeinput"><span class="keyword">function</span> varargout = v_osEMData(varargin)
<span class="comment">% Check os models against neural data (simulating eye movements)</span>
<span class="comment">%</span>
<span class="comment">% This script tests the linear and biophysical outer segment models of photon</span>
<span class="comment">% isomerizations to photocurrent transduction in the cone outer segments.</span>
<span class="comment">% The simulation is compared with a recording sesssion that simulated eye</span>
<span class="comment">% movements for a natural image stimulus.</span>
<span class="comment">%</span>
<span class="comment">% STATUS as of 2/10/16.</span>
<span class="comment">%</span>
<span class="comment">%  * This fetches using the remote data toolbox the eyeMovementExample file</span>
<span class="comment">%  provided by Fred's lab and compares model predictions</span>
<span class="comment">% given input isomerizations with measured photocurrent.</span>
<span class="comment">%  * The agreement is good up to a constant current offset, which we</span>
<span class="comment">%  understand is due to features of the measurement and/or the way the data were saved.</span>
<span class="comment">%</span>
<span class="comment">% Currently, the validation data DC value is simply shifted to match the</span>
<span class="comment">% model predictions.  Better would be to specify in the eyeMovementExample</span>
<span class="comment">% data file the offset that provides the best estimate of the real</span>
<span class="comment">% measurement offset. Or, if this isn't possible, then things are fine, but</span>
<span class="comment">% we should know that and write it down here and/or in a comment about the</span>
<span class="comment">% eyeMovementExample data file.</span>
<span class="comment">%</span>
<span class="comment">% 6/xx/2015    npc   Created.</span>
<span class="comment">% 7/xx/2015    jrg   Test with ISETBIO outersegment object</span>
<span class="comment">% 12/31/15     dhb   Added local copy of coneAdapt.</span>
<span class="comment">% 1/7/16       dhb   Rename.  Started to remove reference to coneAdapt.</span>
<span class="comment">%                    Last version with coneAdapt comparison is in tagged</span>
<span class="comment">%                    version OSObjectVsOrigValidation.</span>
<span class="comment">% 1/12/16      npc   Created this version after separating the eye movements</span>
<span class="comment">%                    component from s_coneModelValidate.</span>
<span class="comment">% 11/17/2016   jrg   Converted to cone mosaic, incorporated both linear and</span>
<span class="comment">%                    biophysical os models.</span>
<span class="comment">% 2016 ISETBIO Team</span>

varargout = UnitTest.runValidationRun(@ValidationFunction, nargout, varargin);

<span class="keyword">end</span>
</pre><h2>Function implementing the isetbio validation code<a name="2"></a></h2><pre class="codeinput"><span class="keyword">function</span> ValidationFunction(runTimeParams)
</pre><h2>Init<a name="4"></a></h2><p>ieInit;</p><h2>Load measured outer segment data.  usec time base<a name="5"></a></h2><pre class="codeinput">    [time, measuredOuterSegmentCurrent, stimulusPhotonRate] = loadMeasuredOuterSegmentResponses();

    <span class="comment">% Set the simulation time interval equal to the temporal sampling resolution of the measured measured data</span>
    <span class="comment">% In generar, the stimulation time interval should be set to a small enough value so as to avoid overflow errors.</span>
    simulationTimeIntervalInSeconds = time(2)-time(1);
</pre><h2>Linear model<a name="6"></a></h2><pre class="codeinput">    osCML = osLinear();            <span class="comment">% peripheral (fast) cone dynamics</span>
    osCML.set(<span class="string">'noise flag'</span>,<span class="string">'none'</span>);
    cmL = coneMosaic(<span class="string">'os'</span>,osCML,<span class="string">'pattern'</span>, 2); <span class="comment">% a single cone</span>
    cmL.integrationTime = simulationTimeIntervalInSeconds;
    cmL.os.timeStep = simulationTimeIntervalInSeconds;
    cmL.absorptions  = reshape(stimulusPhotonRate, [1 1 size(stimulusPhotonRate,2)])*simulationTimeIntervalInSeconds;
    <span class="comment">% Compute outer segment currents.</span>
    cmL.computeCurrent();
    osLinearOuterSegmentCurrent = (cmL.current);

    osLinearOuterSegmentCurrent = squeeze(osLinearOuterSegmentCurrent(1,1,:));
</pre><pre class="codeoutput">No current noise added.
</pre><h2>Biophys model<a name="7"></a></h2><pre class="codeinput">    osCM = osBioPhys();            <span class="comment">% peripheral (fast) cone dynamics</span>
    osCM.set(<span class="string">'noise flag'</span>,<span class="string">'none'</span>);
    cm = coneMosaic(<span class="string">'os'</span>,osCM,<span class="string">'pattern'</span>, 2); <span class="comment">% a single cone</span>
    cm.integrationTime = simulationTimeIntervalInSeconds;
    cm.os.timeStep = simulationTimeIntervalInSeconds;
    cm.absorptions  = reshape(stimulusPhotonRate, [1 1 size(stimulusPhotonRate,2)])*simulationTimeIntervalInSeconds;
    <span class="comment">% Compute outer segment currents.</span>
    cm.computeCurrent(<span class="string">'bgR'</span>,(cm.absorptions(1,1,1))./cm.integrationTime);
    osBiophysOuterSegmentCurrent = (cm.current);

    osBiophysOuterSegmentCurrent = squeeze(osBiophysOuterSegmentCurrent(1,1,:));
</pre><h2>Handle initial offsets<a name="8"></a></h2><pre class="codeinput">    offset1Time = 0.35;
    [~,offset1TimeBin] = min(abs(time - offset1Time ));

    offset2Time = 9.1;
    [~,offset2TimeBin] = min(abs(time - offset2Time ));

    <span class="comment">% Make the current level match at the offset times</span>
    measuredOuterSegmentCurrentLinearOffset1 = measuredOuterSegmentCurrent +  (osLinearOuterSegmentCurrent(offset1TimeBin)-measuredOuterSegmentCurrent(offset1TimeBin));
    measuredOuterSegmentCurrentLinearOffset2 = measuredOuterSegmentCurrent +  (osLinearOuterSegmentCurrent(offset2TimeBin)-measuredOuterSegmentCurrent(offset2TimeBin));

    measuredOuterSegmentCurrentOffset1 = measuredOuterSegmentCurrent +  (osBiophysOuterSegmentCurrent(offset1TimeBin)-measuredOuterSegmentCurrent(offset1TimeBin));
    measuredOuterSegmentCurrentOffset2 = measuredOuterSegmentCurrent +  (osBiophysOuterSegmentCurrent(offset2TimeBin)-measuredOuterSegmentCurrent(offset2TimeBin));
</pre><h2>Compute RMS error<a name="9"></a></h2><p>Why are there so many NaNs in the measured data?</p><pre class="codeinput">    residualLinear1 = osLinearOuterSegmentCurrent(:)-measuredOuterSegmentCurrentLinearOffset1(:);
    residualLinear2 = osLinearOuterSegmentCurrent(:)-measuredOuterSegmentCurrentLinearOffset2(:);
    validIndices = find(~isnan(measuredOuterSegmentCurrent));
    errorLinearRMS1 = sqrt(mean(residualLinear1(validIndices).^2));
    errorLinearRMS2 = sqrt(mean(residualLinear2(validIndices).^2));

    residual1 = osBiophysOuterSegmentCurrent(:)-measuredOuterSegmentCurrentOffset1(:);
    residual2 = osBiophysOuterSegmentCurrent(:)-measuredOuterSegmentCurrentOffset2(:);
    validIndices = find(~isnan(measuredOuterSegmentCurrent));
    errorRMS1 = sqrt(mean(residual1(validIndices).^2));
    errorRMS2 = sqrt(mean(residual2(validIndices).^2));
</pre><h2>Plot the two calculations and compare against measured data.<a name="10"></a></h2><pre class="codeinput">    <span class="keyword">if</span> (runTimeParams.generatePlots)
        h = vcNewGraphWin([],<span class="string">'tall'</span>);
        subplot(2,1,1)
        <span class="comment">% subplot('Position', [0.05 0.54 0.94 0.42]);</span>
        stairs(time,stimulusPhotonRate, <span class="string">'r-'</span>,  <span class="string">'LineWidth'</span>, 2.0);
        set(gca, <span class="string">'XLim'</span>, [time(1) time(end)], <span class="string">'FontSize'</span>, 12);
        ylabel(<span class="string">'Stimulus (R*/sec)'</span>,<span class="string">'FontSize'</span>,14);

        subplot(2,1,2)
        <span class="comment">% subplot('Position', [0.05 0.03 0.94 0.46]);</span>
        <span class="comment">% plot(time, measuredOuterSegmentCurrent, '.-', 'LineWidth', 2.0); hold on;</span>
        <span class="comment">% plot(time, measuredOuterSegmentCurrentOffset1, 'm-', 'LineWidth', 2.0);</span>
        plot(time, measuredOuterSegmentCurrentOffset2, <span class="string">'b-'</span>, <span class="string">'LineWidth'</span>, 2.0); hold <span class="string">on</span>;
        plot(time, osLinearOuterSegmentCurrent, <span class="string">'k-'</span>,  <span class="string">'LineWidth'</span>, 2.0);
        plot(time, osBiophysOuterSegmentCurrent, <span class="string">'m-'</span>,  <span class="string">'LineWidth'</span>, 2.0);
        <span class="comment">% plot(time(offset1TimeBin)*[1 1], [-100 100], 'm-');</span>
        <span class="comment">% plot(time(offset2TimeBin)*[1 1], [-100 100], 'b-');</span>
        set(gca, <span class="string">'XLim'</span>, [time(1) time(end)], <span class="string">'FontSize'</span>, 12);
        xlabel(<span class="string">'Time (sec)'</span>,<span class="string">'FontSize'</span>,14);
        ylabel(<span class="string">'Photocurrent (pA)'</span>,<span class="string">'FontSize'</span>,14);
        <span class="comment">% h = legend('measured (as saved in datafile)', sprintf('measured (adjusted to match model at %2.2f sec)', offset1Time),  sprintf('measured (adjusted to match model at %2.2f msec)',offset2Time) ,'osLinear model', 'osBioPhys model', 'location', 'NorthWest');</span>
        h = legend( sprintf(<span class="string">'measured (adjusted to match model at %2.2f msec)'</span>,offset2Time) ,<span class="string">'osLinear model'</span>, <span class="string">'osBioPhys model'</span>, <span class="string">'location'</span>, <span class="string">'NorthEast'</span>);
        set(h, <span class="string">'FontSize'</span>, 12);
        title(sprintf(<span class="string">'rms: %2.2f pA (offset at %2.2f sec)\nrms: %2.2f pA (offset at %2.2f sec)'</span>, errorRMS1, offset1Time, errorRMS2, offset2Time), <span class="string">'FontName'</span>, <span class="string">'Fixed'</span>);
        drawnow;
    <span class="keyword">end</span>
</pre><img vspace="5" hspace="5" src="v_osEMData_01.png" style="width:717px;height:1224px;" alt=""> <h2>Save validation data<a name="11"></a></h2><pre class="codeinput">    UnitTest.validationData(<span class="string">'osLinearCur'</span>, osLinearOuterSegmentCurrent);
    UnitTest.validationData(<span class="string">'osBiophysCur'</span>, osBiophysOuterSegmentCurrent);
    UnitTest.validationData(<span class="string">'time'</span>, time);
    UnitTest.validationData(<span class="string">'stimulusPhotonRate'</span>, stimulusPhotonRate);
</pre><pre class="codeinput"><span class="keyword">end</span>
</pre><h2>Helper functions<a name="13"></a></h2><pre class="codeinput"><span class="keyword">function</span> [time, measuredOuterSegmentCurrent, stimulusPhotonRate] = loadMeasuredOuterSegmentResponses()

    dataSource = {<span class="string">'resources/data/cones'</span>, <span class="string">'eyeMovementExample'</span>};
    fprintf(<span class="string">'Fetching remote data: dir=''%s''  file=''%s''. Please wait ...\n'</span>, dataSource{1}, dataSource{2});
    <span class="comment">% Download neural data from isetbio's repository</span>
    client = RdtClient(<span class="string">'isetbio'</span>);
    client.crp(dataSource{1});
    [eyeMovementExample, eyeMovementExampleArtifact] = client.readArtifact(dataSource{2}, <span class="string">'type'</span>, <span class="string">'mat'</span>);
    fprintf(<span class="string">'Done fetching data.\n'</span>);

    extraTimeForBaselineComputation = 2.0;

    <span class="comment">% time axis</span>
    dt = eyeMovementExample.data.TimeAxis(2)-eyeMovementExample.data.TimeAxis(1);
    postStimulusTime = eyeMovementExample.data.TimeAxis(end) + dt*(1:(round(extraTimeForBaselineComputation/dt)));
    time = [eyeMovementExample.data.TimeAxis postStimulusTime];

    measuredOuterSegmentCurrent = nan(size(time));
    stimulusPhotonRate = time * 0;

    <span class="comment">% Retrieve the (baseline-corrected) outer segment current</span>
    stimTimeBins = 1:numel(eyeMovementExample.data.TimeAxis);
    measuredOuterSegmentCurrent(stimTimeBins) = squeeze(eyeMovementExample.data.Mean);

    <span class="comment">% standard deviation of the current ?</span>
    <span class="comment">% measuredOuterSegmentCurrentSD = eyeMovementExample.data.SD;</span>

    <span class="comment">% stimulus in isomerizations/sec</span>
    stimulusPhotonRate(stimTimeBins) = eyeMovementExample.data.Stim;
<span class="keyword">end</span>
</pre><pre class="codeoutput">Fetching remote data: dir='resources/data/cones'  file='eyeMovementExample'. Please wait ...
Done fetching data.
</pre><p class="footer"><br><a href="http://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2016a</a><br></p></div><!--
##### SOURCE BEGIN #####
function varargout = v_osEMData(varargin)
% Check os models against neural data (simulating eye movements)
%
% This script tests the linear and biophysical outer segment models of photon
% isomerizations to photocurrent transduction in the cone outer segments.
% The simulation is compared with a recording sesssion that simulated eye
% movements for a natural image stimulus.
%
% STATUS as of 2/10/16.  
%
%  * This fetches using the remote data toolbox the eyeMovementExample file
%  provided by Fred's lab and compares model predictions
% given input isomerizations with measured photocurrent.  
%  * The agreement is good up to a constant current offset, which we
%  understand is due to features of the measurement and/or the way the data were saved.
%
% Currently, the validation data DC value is simply shifted to match the
% model predictions.  Better would be to specify in the eyeMovementExample
% data file the offset that provides the best estimate of the real
% measurement offset. Or, if this isn't possible, then things are fine, but
% we should know that and write it down here and/or in a comment about the
% eyeMovementExample data file.
%
% 6/xx/2015    npc   Created.
% 7/xx/2015    jrg   Test with ISETBIO outersegment object
% 12/31/15     dhb   Added local copy of coneAdapt.            
% 1/7/16       dhb   Rename.  Started to remove reference to coneAdapt.  
%                    Last version with coneAdapt comparison is in tagged
%                    version OSObjectVsOrigValidation.
% 1/12/16      npc   Created this version after separating the eye movements 
%                    component from s_coneModelValidate.
% 11/17/2016   jrg   Converted to cone mosaic, incorporated both linear and
%                    biophysical os models.
% 2016 ISETBIO Team

varargout = UnitTest.runValidationRun(@ValidationFunction, nargout, varargin);

end

%% Function implementing the isetbio validation code
function ValidationFunction(runTimeParams)

    %% Init
    % ieInit;

    %% Load measured outer segment data.  usec time base
    [time, measuredOuterSegmentCurrent, stimulusPhotonRate] = loadMeasuredOuterSegmentResponses();
    
    % Set the simulation time interval equal to the temporal sampling resolution of the measured measured data
    % In generar, the stimulation time interval should be set to a small enough value so as to avoid overflow errors.
    simulationTimeIntervalInSeconds = time(2)-time(1);
    
    %% Linear model
    osCML = osLinear();            % peripheral (fast) cone dynamics
    osCML.set('noise flag','none');
    cmL = coneMosaic('os',osCML,'pattern', 2); % a single cone
    cmL.integrationTime = simulationTimeIntervalInSeconds;
    cmL.os.timeStep = simulationTimeIntervalInSeconds;
    cmL.absorptions  = reshape(stimulusPhotonRate, [1 1 size(stimulusPhotonRate,2)])*simulationTimeIntervalInSeconds;
    % Compute outer segment currents.
    cmL.computeCurrent();
    osLinearOuterSegmentCurrent = (cmL.current);
    
    osLinearOuterSegmentCurrent = squeeze(osLinearOuterSegmentCurrent(1,1,:));
    
    %% Biophys model
    osCM = osBioPhys();            % peripheral (fast) cone dynamics
    osCM.set('noise flag','none');
    cm = coneMosaic('os',osCM,'pattern', 2); % a single cone
    cm.integrationTime = simulationTimeIntervalInSeconds;
    cm.os.timeStep = simulationTimeIntervalInSeconds;
    cm.absorptions  = reshape(stimulusPhotonRate, [1 1 size(stimulusPhotonRate,2)])*simulationTimeIntervalInSeconds;
    % Compute outer segment currents.
    cm.computeCurrent('bgR',(cm.absorptions(1,1,1))./cm.integrationTime);
    osBiophysOuterSegmentCurrent = (cm.current);
    
    osBiophysOuterSegmentCurrent = squeeze(osBiophysOuterSegmentCurrent(1,1,:));
    
    %% Handle initial offsets
    offset1Time = 0.35;
    [~,offset1TimeBin] = min(abs(time - offset1Time ));

    offset2Time = 9.1;
    [~,offset2TimeBin] = min(abs(time - offset2Time ));
    
    % Make the current level match at the offset times
    measuredOuterSegmentCurrentLinearOffset1 = measuredOuterSegmentCurrent +  (osLinearOuterSegmentCurrent(offset1TimeBin)-measuredOuterSegmentCurrent(offset1TimeBin));
    measuredOuterSegmentCurrentLinearOffset2 = measuredOuterSegmentCurrent +  (osLinearOuterSegmentCurrent(offset2TimeBin)-measuredOuterSegmentCurrent(offset2TimeBin));
  
    measuredOuterSegmentCurrentOffset1 = measuredOuterSegmentCurrent +  (osBiophysOuterSegmentCurrent(offset1TimeBin)-measuredOuterSegmentCurrent(offset1TimeBin));
    measuredOuterSegmentCurrentOffset2 = measuredOuterSegmentCurrent +  (osBiophysOuterSegmentCurrent(offset2TimeBin)-measuredOuterSegmentCurrent(offset2TimeBin));
    
    %% Compute RMS error  
    % Why are there so many NaNs in the measured data?
    residualLinear1 = osLinearOuterSegmentCurrent(:)-measuredOuterSegmentCurrentLinearOffset1(:);
    residualLinear2 = osLinearOuterSegmentCurrent(:)-measuredOuterSegmentCurrentLinearOffset2(:);
    validIndices = find(~isnan(measuredOuterSegmentCurrent));
    errorLinearRMS1 = sqrt(mean(residualLinear1(validIndices).^2));
    errorLinearRMS2 = sqrt(mean(residualLinear2(validIndices).^2));

    residual1 = osBiophysOuterSegmentCurrent(:)-measuredOuterSegmentCurrentOffset1(:);
    residual2 = osBiophysOuterSegmentCurrent(:)-measuredOuterSegmentCurrentOffset2(:);
    validIndices = find(~isnan(measuredOuterSegmentCurrent));
    errorRMS1 = sqrt(mean(residual1(validIndices).^2));
    errorRMS2 = sqrt(mean(residual2(validIndices).^2));

    %% Plot the two calculations and compare against measured data.
    if (runTimeParams.generatePlots)
        h = vcNewGraphWin([],'tall');
        subplot(2,1,1)
        % subplot('Position', [0.05 0.54 0.94 0.42]);
        stairs(time,stimulusPhotonRate, 'r-',  'LineWidth', 2.0);
        set(gca, 'XLim', [time(1) time(end)], 'FontSize', 12);
        ylabel('Stimulus (R*/sec)','FontSize',14);
        
        subplot(2,1,2)
        % subplot('Position', [0.05 0.03 0.94 0.46]);
        % plot(time, measuredOuterSegmentCurrent, '.-', 'LineWidth', 2.0); hold on;
        % plot(time, measuredOuterSegmentCurrentOffset1, 'm-', 'LineWidth', 2.0);
        plot(time, measuredOuterSegmentCurrentOffset2, 'b-', 'LineWidth', 2.0); hold on;             
        plot(time, osLinearOuterSegmentCurrent, 'k-',  'LineWidth', 2.0);
        plot(time, osBiophysOuterSegmentCurrent, 'm-',  'LineWidth', 2.0);  
        % plot(time(offset1TimeBin)*[1 1], [-100 100], 'm-');
        % plot(time(offset2TimeBin)*[1 1], [-100 100], 'b-');
        set(gca, 'XLim', [time(1) time(end)], 'FontSize', 12);
        xlabel('Time (sec)','FontSize',14);
        ylabel('Photocurrent (pA)','FontSize',14);
        % h = legend('measured (as saved in datafile)', sprintf('measured (adjusted to match model at %2.2f sec)', offset1Time),  sprintf('measured (adjusted to match model at %2.2f msec)',offset2Time) ,'osLinear model', 'osBioPhys model', 'location', 'NorthWest');
        h = legend( sprintf('measured (adjusted to match model at %2.2f msec)',offset2Time) ,'osLinear model', 'osBioPhys model', 'location', 'NorthEast');
        set(h, 'FontSize', 12);
        title(sprintf('rms: %2.2f pA (offset at %2.2f sec)\nrms: %2.2f pA (offset at %2.2f sec)', errorRMS1, offset1Time, errorRMS2, offset2Time), 'FontName', 'Fixed');
        drawnow;
    end
    
    %% Save validation data    
    UnitTest.validationData('osLinearCur', osLinearOuterSegmentCurrent);
    UnitTest.validationData('osBiophysCur', osBiophysOuterSegmentCurrent);
    UnitTest.validationData('time', time);
    UnitTest.validationData('stimulusPhotonRate', stimulusPhotonRate);
end

%% Helper functions
function [time, measuredOuterSegmentCurrent, stimulusPhotonRate] = loadMeasuredOuterSegmentResponses()
    
    dataSource = {'resources/data/cones', 'eyeMovementExample'};
    fprintf('Fetching remote data: dir=''%s''  file=''%s''. Please wait ...\n', dataSource{1}, dataSource{2});
    % Download neural data from isetbio's repository
    client = RdtClient('isetbio');
    client.crp(dataSource{1});
    [eyeMovementExample, eyeMovementExampleArtifact] = client.readArtifact(dataSource{2}, 'type', 'mat');
    fprintf('Done fetching data.\n');
    
    extraTimeForBaselineComputation = 2.0;
    
    % time axis
    dt = eyeMovementExample.data.TimeAxis(2)-eyeMovementExample.data.TimeAxis(1);
    postStimulusTime = eyeMovementExample.data.TimeAxis(end) + dt*(1:(round(extraTimeForBaselineComputation/dt)));
    time = [eyeMovementExample.data.TimeAxis postStimulusTime];
    
    measuredOuterSegmentCurrent = nan(size(time));
    stimulusPhotonRate = time * 0;
    
    % Retrieve the (baseline-corrected) outer segment current
    stimTimeBins = 1:numel(eyeMovementExample.data.TimeAxis);
    measuredOuterSegmentCurrent(stimTimeBins) = squeeze(eyeMovementExample.data.Mean);
    
    % standard deviation of the current ?
    % measuredOuterSegmentCurrentSD = eyeMovementExample.data.SD;
    
    % stimulus in isomerizations/sec
    stimulusPhotonRate(stimTimeBins) = eyeMovementExample.data.Stim;
end


##### SOURCE END #####
--></body></html>