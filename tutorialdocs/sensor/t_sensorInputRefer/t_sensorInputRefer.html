
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>t_sensorInputRefer</title><meta name="generator" content="MATLAB 8.4"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2015-08-13"><meta name="DC.source" content="t_sensorInputRefer.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; } 

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h2>Contents</h2><div><ul><li><a href="#1">t_sensorInputRefer</a></li><li><a href="#2">A target photon absorption rate for the sensor</a></li><li><a href="#3">Calculate the photon absorption rate for a 1 cd/m2 at 1 sec</a></li><li><a href="#4">Calculate the mean photon absorption rate directly from the oi and sensor</a></li><li><a href="#5">The ISET calculation produces the same mean rate</a></li><li><a href="#6">Calculate how to adjust the scene luminance</a></li><li><a href="#7">Compute the photon rate at the new scene luminance level</a></li><li><a href="#8">Histogram of photon numbers and expected Poisson distribution</a></li><li><a href="#9">END</a></li></ul></div><h2>t_sensorInputRefer<a name="1"></a></h2><p>Illustrates how to calculate the mean absorption rate at the detector given a uniform scene.</p><p>Then illustrates how to set the  scene luminance of a uniform, equal energy scene to achieve any specified absorption rate.</p><p>Hence, when we know the number of electrons in a particular type of pixel, we can estimate the illuminance of an equal energy light at the sensor, or the luminance of an equal energy light in the scene, prior to the optics.</p><p>BW ISETBIO Team, 2015</p><pre class="codeinput">ieInit
</pre><h2>A target photon absorption rate for the sensor<a name="2"></a></h2><pre class="codeinput">tRate = 2;

fprintf(<span class="string">'Adjusting to a target rate of %.4f\n'</span>,tRate);
</pre><pre class="codeoutput">Adjusting to a target rate of 2.0000
</pre><h2>Calculate the photon absorption rate for a 1 cd/m2 at 1 sec<a name="3"></a></h2><pre class="codeinput">s = sceneCreate(<span class="string">'uniform ee'</span>);
lum = 1;
s = sceneAdjustLuminance(s,lum);  <span class="comment">% 1 cd/m2</span>

oi = oiCreate;
oi = oiCompute(oi,s);

sensor = sensorCreate(<span class="string">'monochrome'</span>);
noiseFlag = 1;
sensor = sensorSet(sensor,<span class="string">'noise flag'</span>,noiseFlag);
sensor = sensorSet(sensor,<span class="string">'exp time'</span>,1);
</pre><h2>Calculate the mean photon absorption rate directly from the oi and sensor<a name="4"></a></h2><pre class="codeinput"><span class="comment">% This is a form of the code from signalCurrent.m</span>
q = vcConstants(<span class="string">'q'</span>);     <span class="comment">%Charge/electron</span>

<span class="comment">% signalCurrent estimates volts, like this.  We want current to electrons</span>
<span class="comment">% (which for the human case is current to photons)</span>
<span class="comment">%</span>
<span class="comment">% Convert current (Amps) to volts</span>
<span class="comment">% Check the units:</span>
<span class="comment">%  S * (V / e) * (Coulombs / e)^-1   % https://en.wikipedia.org/wiki/Coulomb</span>
<span class="comment">%    = S * (V / e) * (( A S ) / e) ^-1</span>
<span class="comment">%    = S * (V / e) * ( e / (A S)) = (V / A)</span>
<span class="comment">% c2v = sensorGet(sensor,'integrationTime')*sensorGet(sensor,'pixel conversion gain') / q;</span>
<span class="comment">%</span>
<span class="comment">%  S * (Coulombs / e)^-1</span>
<span class="comment">%    = S * ( A S / e)^-1</span>
<span class="comment">%    = e / A</span>
c2e = sensorGet(sensor,<span class="string">'integration time'</span>)/ q;

<span class="comment">% Signal current returns Amps/pixel/sec</span>
<span class="comment">%  c2e * Amps/pixel/sec</span>
<span class="comment">%    = (e/A) * (A/pixel/sec)</span>
<span class="comment">%    = e / pixel / sec</span>
pImage = c2e*signalCurrent(oi,sensor);

fprintf(<span class="string">'Direct calculation of photon rate:  %.4f \n'</span>,mean(pImage(:)))
</pre><pre class="codeoutput">Direct calculation of photon rate:  3318.4140 
</pre><h2>The ISET calculation produces the same mean rate<a name="5"></a></h2><pre class="codeinput">sensor = sensorCompute(sensor,oi);

<span class="comment">% Get the photons from the first pixel type</span>
photons = sensorGet(sensor,<span class="string">'photons'</span>);

<span class="comment">% In the middle of the image to avoid the edges</span>
photons = getMiddleMatrix(photons,[40,40]);

<span class="comment">% This is the Photon absorptions per exposure (which is 1 sec)</span>
pRate = mean(photons(:));

<span class="comment">% ieAddObject(oi); ieAddObject(sensor);</span>
<span class="comment">% oiWindow; sensorImageWindow;</span>
</pre><h2>Calculate how to adjust the scene luminance<a name="6"></a></h2><pre class="codeinput"><span class="comment">% Scale the scene luminance</span>
newLum = lum * (tRate/pRate);
fprintf(<span class="string">'Adjusting the scene luminance to %e cd/m^2\n'</span>,newLum);
s = sceneAdjustLuminance(s,newLum);  <span class="comment">% 1 cd/m2</span>
</pre><pre class="codeoutput">Adjusting the scene luminance to 6.024025e-04 cd/m^2
</pre><h2>Compute the photon rate at the new scene luminance level<a name="7"></a></h2><pre class="codeinput">oi = oiCompute(oi,s);
fprintf(<span class="string">'Through the optics the illuminance is %e lux\n'</span>,oiGet(oi,<span class="string">'mean illuminance'</span>));

sensor = sensorCompute(sensor,oi);
photons = sensorGet(sensor,<span class="string">'photons'</span>,1);

<span class="comment">% Photon absorptions per exposure</span>
fprintf(<span class="string">'Computed mean photon rate %e\n'</span>,mean(photons(:)))

<span class="comment">% Show the distribution</span>
<span class="comment">% vcNewGraphWin; hist(photons(:),50)</span>

c2e = sensorGet(sensor,<span class="string">'integration time'</span>)/ q;

<span class="comment">% Signal current returns Amps/pixel/sec</span>
<span class="comment">%  c2e * Amps/pixel/sec</span>
<span class="comment">%    = (e/A) * (A/pixel/sec)</span>
<span class="comment">%    = e / pixel / sec</span>
pImage = c2e*signalCurrent(oi,sensor);

fprintf(<span class="string">'Direct calculation of photon rate:  %.4f (target = %.4f)\n'</span>,mean(pImage(:)),tRate)
</pre><pre class="codeoutput">Through the optics the illuminance is 2.863757e-05 lux
Computed mean photon rate 2.021938e+00
Direct calculation of photon rate:  1.9990 (target = 2.0000)
</pre><h2>Histogram of photon numbers and expected Poisson distribution<a name="8"></a></h2><pre class="codeinput">nSamp = round(max(2*sqrt(tRate)*50,1000));
val = iePoisson(tRate,nSamp);

xval =  min(photons(:)):max(photons(:));

vcNewGraphWin;
n = hist(val(:),xval); bar(xval,n/sum(n(:))); hold <span class="string">on</span>;

[n,c] = hist(photons(:),xval);
n = n/sum(n(:)); lst = (n &gt; 0);
plot(c(lst),n(lst),<span class="string">'ro-'</span>,<span class="string">'linewidth'</span>,2);

xlabel(<span class="string">'Photon count'</span>); ylabel(<span class="string">'Number'</span>)
title(sprintf(<span class="string">'Photon distribution (mean %.3f)'</span>,mean(pImage(:))));
</pre><img vspace="5" hspace="5" src="t_sensorInputRefer_01.png" alt=""> <h2>END<a name="9"></a></h2><p class="footer"><br><a href="http://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2014b</a><br></p></div><!--
##### SOURCE BEGIN #####
%% t_sensorInputRefer
%
% Illustrates how to calculate the mean absorption rate at the detector
% given a uniform scene.  
%
% Then illustrates how to set the  scene luminance of a uniform, equal
% energy scene to achieve any specified absorption rate.
%
% Hence, when we know the number of electrons in a particular type of
% pixel, we can estimate the illuminance of an equal energy light at the
% sensor, or the luminance of an equal energy light in the scene, prior to
% the optics.
%
% BW ISETBIO Team, 2015

ieInit

%% A target photon absorption rate for the sensor
tRate = 2;  

fprintf('Adjusting to a target rate of %.4f\n',tRate);

%%  Calculate the photon absorption rate for a 1 cd/m2 at 1 sec
s = sceneCreate('uniform ee');
lum = 1;
s = sceneAdjustLuminance(s,lum);  % 1 cd/m2

oi = oiCreate;
oi = oiCompute(oi,s);

sensor = sensorCreate('monochrome');
noiseFlag = 1;
sensor = sensorSet(sensor,'noise flag',noiseFlag);
sensor = sensorSet(sensor,'exp time',1);

%% Calculate the mean photon absorption rate directly from the oi and sensor

% This is a form of the code from signalCurrent.m
q = vcConstants('q');     %Charge/electron
    
% signalCurrent estimates volts, like this.  We want current to electrons
% (which for the human case is current to photons)
%
% Convert current (Amps) to volts
% Check the units:
%  S * (V / e) * (Coulombs / e)^-1   % https://en.wikipedia.org/wiki/Coulomb
%    = S * (V / e) * (( A S ) / e) ^-1
%    = S * (V / e) * ( e / (A S)) = (V / A)
% c2v = sensorGet(sensor,'integrationTime')*sensorGet(sensor,'pixel conversion gain') / q;
%
%  S * (Coulombs / e)^-1 
%    = S * ( A S / e)^-1
%    = e / A
c2e = sensorGet(sensor,'integration time')/ q;

% Signal current returns Amps/pixel/sec
%  c2e * Amps/pixel/sec 
%    = (e/A) * (A/pixel/sec)
%    = e / pixel / sec
pImage = c2e*signalCurrent(oi,sensor);

fprintf('Direct calculation of photon rate:  %.4f \n',mean(pImage(:)))


%%  The ISET calculation produces the same mean rate

sensor = sensorCompute(sensor,oi);

% Get the photons from the first pixel type
photons = sensorGet(sensor,'photons');

% In the middle of the image to avoid the edges
photons = getMiddleMatrix(photons,[40,40]);

% This is the Photon absorptions per exposure (which is 1 sec)
pRate = mean(photons(:));

% ieAddObject(oi); ieAddObject(sensor);
% oiWindow; sensorImageWindow;

%% Calculate how to adjust the scene luminance

% Scale the scene luminance
newLum = lum * (tRate/pRate);
fprintf('Adjusting the scene luminance to %e cd/m^2\n',newLum);
s = sceneAdjustLuminance(s,newLum);  % 1 cd/m2

%% Compute the photon rate at the new scene luminance level

oi = oiCompute(oi,s);
fprintf('Through the optics the illuminance is %e lux\n',oiGet(oi,'mean illuminance'));

sensor = sensorCompute(sensor,oi);
photons = sensorGet(sensor,'photons',1);

% Photon absorptions per exposure
fprintf('Computed mean photon rate %e\n',mean(photons(:)))

% Show the distribution
% vcNewGraphWin; hist(photons(:),50)

c2e = sensorGet(sensor,'integration time')/ q;

% Signal current returns Amps/pixel/sec
%  c2e * Amps/pixel/sec 
%    = (e/A) * (A/pixel/sec)
%    = e / pixel / sec
pImage = c2e*signalCurrent(oi,sensor);

fprintf('Direct calculation of photon rate:  %.4f (target = %.4f)\n',mean(pImage(:)),tRate)

%% Histogram of photon numbers and expected Poisson distribution

nSamp = round(max(2*sqrt(tRate)*50,1000));
val = iePoisson(tRate,nSamp);

xval =  min(photons(:)):max(photons(:));

vcNewGraphWin;
n = hist(val(:),xval); bar(xval,n/sum(n(:))); hold on;

[n,c] = hist(photons(:),xval);
n = n/sum(n(:)); lst = (n > 0);
plot(c(lst),n(lst),'ro-','linewidth',2);

xlabel('Photon count'); ylabel('Number')
title(sprintf('Photon distribution (mean %.3f)',mean(pImage(:))));


%% END

##### SOURCE END #####
--></body></html>