
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>t_osCurrentsVsLuminanceLevel</title><meta name="generator" content="MATLAB 9.0"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2016-12-11"><meta name="DC.source" content="t_osCurrentsVsLuminanceLevel.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; } 

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><pre class="codeinput"><span class="keyword">function</span> t_osCurrentsVsLuminanceLevel

    <span class="comment">% Define the time axis for the simulation</span>
    stimulusSamplingInterval = 1/1000;             <span class="comment">% 50/1000</span>
    oiTimeAxis = 0:stimulusSamplingInterval:0.3;   <span class="comment">% 2.0</span>
    oiTimeAxis = oiTimeAxis - mean(oiTimeAxis);

    <span class="comment">% Compute the stimulus modulation function</span>
    stimulusRampTau = 5/1000;  <span class="comment">% 0.18;</span>
    modulationGain = 1.0;
    modulationFunction = modulationGain * exp(-0.5*(oiTimeAxis/stimulusRampTau).^2);

    <span class="comment">% Generate optics</span>
    noOptics = false;
    theOI = oiGenerate(noOptics);

    <span class="comment">% Background luminance levels to be examined</span>
    luminancesExamined = [50:50:1000]; <span class="comment">%  1500 2000 3000];</span>

    <span class="comment">% Outer segment time steps to be examined</span>
    osTimeSteps = [0.1]/1000;

    <span class="comment">% Generate a number of oiSequences, one for each luminance examined</span>
    <span class="keyword">for</span> lumIndex = 1:numel(luminancesExamined)
        <span class="comment">% Generate the scene</span>
        FOV = 1.0;
        theScene = uniformFieldSceneCreate(FOV, luminancesExamined(lumIndex));

        <span class="comment">% Compute the optical images</span>
        oiBackground = oiCompute(theOI, theScene);
        oiModulated  = oiBackground;

        <span class="comment">% Generate the sequence of optical images</span>
        pos = oiGet(oiBackground, <span class="string">'spatial support'</span>, <span class="string">'microns'</span>);
        modulationRegion.radiusInMicrons = 0.5*max(pos(:));
        theOIsequenceArray{lumIndex} = oiSequence(oiBackground, oiModulated, oiTimeAxis, modulationFunction, <span class="string">'modulationRegion'</span>, modulationRegion);
        <span class="comment">%theOIsequence.visualize('format', 'montage');</span>
    <span class="keyword">end</span> <span class="comment">% lumIndex</span>


    <span class="comment">% Generate a cone mosaic with 1 L-, 1 M-, and 1 S-cone only</span>
    mosaicSize =  nan;
    integrationTime = 1/1000;
    photonNoise = <span class="string">'none'</span>;
    osTimeStep = 1/1000;
    osNoise = <span class="string">'none'</span>;
    theConeMosaic = coneMosaicGenerate(mosaicSize, photonNoise, osNoise, integrationTime, osTimeStep);

    <span class="comment">% Generate eye movement path</span>
    eyeMovementsNum = theOIsequenceArray{1}.maxEyeMovementsNumGivenIntegrationTime(theConeMosaic.integrationTime);
    instancesNum = 1;
    emPaths = zeros(instancesNum, eyeMovementsNum,2);
    <span class="keyword">for</span> instanceIndex = 1:instancesNum
        emPaths(instanceIndex, :, :) = theConeMosaic.emGenSequence(eyeMovementsNum)*0;
    <span class="keyword">end</span>


    hFig = figure(1); clf;
    set(hFig, <span class="string">'Position'</span>, [10 10 1800 1200]);


    subplotPosVectors = NicePlot.getSubPlotPosVectors(<span class="keyword">...</span>
           <span class="string">'rowsNum'</span>, numel(luminancesExamined), <span class="keyword">...</span>
           <span class="string">'colsNum'</span>, numel(osTimeSteps)+1, <span class="keyword">...</span>
           <span class="string">'heightMargin'</span>,   0.02, <span class="keyword">...</span>
           <span class="string">'widthMargin'</span>,    0.02, <span class="keyword">...</span>
           <span class="string">'leftMargin'</span>,     0.03, <span class="keyword">...</span>
           <span class="string">'rightMargin'</span>,    0.00, <span class="keyword">...</span>
           <span class="string">'bottomMargin'</span>,   0.03, <span class="keyword">...</span>
           <span class="string">'topMargin'</span>,      0.01);

    subplotPosVectors2 = NicePlot.getSubPlotPosVectors(<span class="keyword">...</span>
           <span class="string">'rowsNum'</span>, 3, <span class="keyword">...</span>
           <span class="string">'colsNum'</span>, 1+numel(osTimeSteps), <span class="keyword">...</span>
           <span class="string">'heightMargin'</span>,   0.08, <span class="keyword">...</span>
           <span class="string">'widthMargin'</span>,    0.07, <span class="keyword">...</span>
           <span class="string">'leftMargin'</span>,     0.08, <span class="keyword">...</span>
           <span class="string">'rightMargin'</span>,    0.00, <span class="keyword">...</span>
           <span class="string">'bottomMargin'</span>,   0.04, <span class="keyword">...</span>
           <span class="string">'topMargin'</span>,      0.01);

    isomerizationsRange =  [0 200];
    luminanceRange = [0 1100];
    luminanceTicks = [0:200:1100];
    pCurrentRange = [-85 0];
    pCurrentModulationRange = [0 30];

    <span class="keyword">for</span> lumIndex = 1: numel(luminancesExamined)
        <span class="keyword">for</span> osTimeStepIndex = 0:numel(osTimeSteps)
            <span class="keyword">if</span> (osTimeStepIndex &gt; 0)
                theConeMosaic.os.timeStep = osTimeSteps(osTimeStepIndex);
            <span class="keyword">end</span>

            [isomerizations, photocurrents, tmpLMSfilters] = <span class="keyword">...</span>
                theConeMosaic.computeForOISequence(theOIsequenceArray{lumIndex}, <span class="keyword">...</span>
                <span class="string">'emPaths'</span>, emPaths, <span class="keyword">...</span>
                <span class="string">'currentFlag'</span>, true);


            timeAxis = theConeMosaic.timeAxis + theOIsequenceArray{lumIndex}.timeAxis(1);
            timeRange = [timeAxis(1) timeAxis(end)];
            timeRange = [-500 500]/1000;

            <span class="keyword">if</span> (lumIndex == 1) &amp;&amp; (osTimeStepIndex == 1)
                LMSfilters = zeros(numel(luminancesExamined), numel(osTimeSteps), size(tmpLMSfilters,1), size(tmpLMSfilters,2));
            <span class="keyword">end</span>
            <span class="keyword">if</span> (osTimeStepIndex &gt; 0)
               LMSfilters(lumIndex, osTimeStepIndex, :,:) = tmpLMSfilters;
               timeAxisLMSfilters(lumIndex, osTimeStepIndex,:) = (1:size(tmpLMSfilters,1)) * (timeAxis(2)-timeAxis(1));
            <span class="keyword">end</span>

            <span class="comment">% Plot the isomerization signals</span>
            <span class="keyword">if</span> (osTimeStepIndex == 0)
                figure(hFig);
                subplot(<span class="string">'Position'</span>, subplotPosVectors(lumIndex, 1).v);
                plot(timeAxis, squeeze(isomerizations(1,1,1,:)), <span class="string">'r-'</span>, <span class="string">'LineWidth'</span>, 1.5);
                hold <span class="string">on</span>;
                plot(timeAxis, squeeze(isomerizations(1,1,2,:)), <span class="string">'g-'</span>, <span class="string">'LineWidth'</span>, 1.5);
                plot(timeAxis, squeeze(isomerizations(1,1,3,:)), <span class="string">'b-'</span>, <span class="string">'LineWidth'</span>, 1.5);
                set(gca, <span class="string">'XLim'</span>, timeRange);
                title(sprintf(<span class="string">'background lum: %d cd/m2'</span>, luminancesExamined(lumIndex)));
                ylabel(sprintf(<span class="string">'absorptions / %d ms'</span>, theConeMosaic.integrationTime*1000), <span class="string">'FontSize'</span>, 12);
                set(gca, <span class="string">'YLim'</span>, isomerizationsRange, <span class="string">'FontSize'</span>, 12);

                <span class="keyword">if</span> (lumIndex &lt;  numel(luminancesExamined))
                    set(gca, <span class="string">'XTickLabel'</span>, {});
                <span class="keyword">else</span>
                    xlabel(<span class="string">'time (ms)'</span>, <span class="string">'FontSize'</span>, 12);
                <span class="keyword">end</span>
                grid <span class="string">on</span>; box <span class="string">on</span>;
                drawnow;

            <span class="comment">% Plot the photocurrent signals</span>
            <span class="keyword">else</span>
                figure(hFig);
                subplot(<span class="string">'Position'</span>, subplotPosVectors(lumIndex, osTimeStepIndex+1).v);
                plot(timeAxis, squeeze(photocurrents(1,1,1,:)), <span class="string">'r-'</span>, <span class="string">'LineWidth'</span>, 1.5);
                hold <span class="string">on</span>;
                plot(timeAxis, squeeze(photocurrents(1,1,2,:)), <span class="string">'g-'</span>, <span class="string">'LineWidth'</span>, 1.5);
                plot(timeAxis, squeeze(photocurrents(1,1,3,:)), <span class="string">'b-'</span>, <span class="string">'LineWidth'</span>, 1.5);
                set(gca, <span class="string">'XLim'</span>, timeRange);
                title(sprintf(<span class="string">'os.timeStep = %2.3f ms'</span>, theConeMosaic.os.timeStep*1000));
                <span class="keyword">if</span> (osTimeStepIndex == 1)
                    ylabel(<span class="string">'current (pAmps)'</span>);
                <span class="keyword">end</span>
                set(gca, <span class="string">'YLim'</span>, pCurrentRange);

                <span class="keyword">if</span> (osTimeStepIndex &gt; 1)
                    set(gca, <span class="string">'YTickLabel'</span>, {});
                <span class="keyword">end</span>

                <span class="keyword">if</span> (lumIndex == numel(luminancesExamined))
                    xlabel(<span class="string">'time (seconds)'</span>);
                <span class="keyword">else</span>
                    set(gca, <span class="string">'XTickLabel'</span>, {});
                <span class="keyword">end</span>
                set(gca, <span class="string">'FontSize'</span>, 10);
                grid <span class="string">on</span>; box <span class="string">on</span>;
                drawnow;
            <span class="keyword">end</span>


            <span class="keyword">if</span> (osTimeStepIndex == 1)
                <span class="comment">% Compute modulation of photocurrents at different background luminance levels</span>

                <span class="keyword">for</span> coneIndex = 1:3
                    photocurrent = squeeze(photocurrents(1,1,coneIndex,:));
                    isomerizationRate = squeeze(isomerizations(1,1,coneIndex,:)) / theConeMosaic.integrationTime;
                    baselineP = photocurrent(end);
                    baselineIR = isomerizationRate(end);
                    <span class="keyword">if</span> (baselineP &lt; 0)
                        deltaPhotocurrent = max(photocurrent(:)) - baselineP;
                    <span class="keyword">else</span>
                        deltaPhotocurrent = 0;
                    <span class="keyword">end</span>
                    photoCurrentModulation(lumIndex,coneIndex) = deltaPhotocurrent;
                    isomerizationRateModulation(lumIndex,coneIndex) = max(isomerizationRate(:))-baselineIR;
                <span class="keyword">end</span> <span class="comment">% coneIndex</span>
            <span class="keyword">end</span>

        <span class="keyword">end</span> <span class="comment">% osTimeStepIndex</span>
    <span class="keyword">end</span> <span class="comment">% lumIndex</span>


    hFig2 = figure(2); clf;
    set(hFig2, <span class="string">'Position'</span>, [10 10 900 1290], <span class="string">'Color'</span>, [1 1 1]);

    modelRegime = [500 20000];
    modelRegimeY = [modelRegime(1) modelRegime(1) modelRegime(2) modelRegime(2) modelRegime(1)];
    modelRegimeX = [luminanceRange(1) luminanceRange(2) luminanceRange(2) luminanceRange(1) pCurrentModulationRange(1)];

    subplot(<span class="string">'Position'</span>, subplotPosVectors2(1,1).v);
    hold <span class="string">on</span>
    patch(modelRegimeX, modelRegimeY, [0.83 0.83 0.63]);
    plot(modelRegimeX, modelRegimeY, <span class="string">'k--'</span>, <span class="string">'LineWidth'</span>, 1.0);
    plot(luminancesExamined, isomerizationRateModulation(:,1), <span class="string">'rs-'</span>, <span class="string">'MarkerFaceColor'</span>, [0.8 0.8 0.8], <span class="string">'LineWidth'</span>, 2.0, <span class="string">'MarkerSize'</span>, 12);
    plot(luminancesExamined, isomerizationRateModulation(:,2), <span class="string">'gs-'</span>, <span class="string">'MarkerFaceColor'</span>, [0.6 0.6 0.6], <span class="string">'LineWidth'</span>, 2.0, <span class="string">'MarkerSize'</span>, 12);
    plot(luminancesExamined, isomerizationRateModulation(:,3), <span class="string">'bs-'</span>, <span class="string">'MarkerFaceColor'</span>, [0.8 0.8 0.8], <span class="string">'LineWidth'</span>, 2.0, <span class="string">'MarkerSize'</span>, 12);

    set(gca, <span class="string">'FontSize'</span>, 14, <span class="string">'XLim'</span>, luminanceRange, <span class="string">'XTick'</span>, luminanceTicks, <span class="string">'XScale'</span>, <span class="string">'linear'</span>, <span class="string">'FontSize'</span>, 12);
    xlabel(<span class="string">'background luminance (cd/m2)'</span>, <span class="string">'FontSize'</span>, 14, <span class="string">'FontWeight'</span>, <span class="string">'bold'</span>);
    ylabel(<span class="string">'isomerization rate modulation (R*/cone/sec)'</span>, <span class="string">'FontSize'</span>, 14, <span class="string">'FontWeight'</span>, <span class="string">'bold'</span>);
    <span class="comment">%hL = legend({'L', 'M', 'S'});set(hL, 'FontSize', 14, 'Location', 'NorthWest');</span>
    grid <span class="string">on</span>; box <span class="string">on</span>;


    subplot(<span class="string">'Position'</span>, subplotPosVectors2(2,1).v);
    hold <span class="string">on</span>
    plot(luminancesExamined, photoCurrentModulation(:,1), <span class="string">'rs-'</span>, <span class="string">'MarkerFaceColor'</span>, [0.8 0.8 0.8], <span class="string">'LineWidth'</span>, 2.0, <span class="string">'MarkerSize'</span>, 12);
    plot(luminancesExamined, photoCurrentModulation(:,2), <span class="string">'gs-'</span>, <span class="string">'MarkerFaceColor'</span>, [0.6 0.6 0.6], <span class="string">'LineWidth'</span>, 2.0, <span class="string">'MarkerSize'</span>, 12);
    plot(luminancesExamined, photoCurrentModulation(:,3), <span class="string">'bs-'</span>, <span class="string">'MarkerFaceColor'</span>, [0.8 0.8 0.8], <span class="string">'LineWidth'</span>, 2.0, <span class="string">'MarkerSize'</span>, 12);

    set(gca, <span class="string">'FontSize'</span>, 14, <span class="string">'XLim'</span>, luminanceRange, <span class="string">'YLim'</span>, pCurrentModulationRange, <span class="string">'XTick'</span>, luminanceTicks, <span class="string">'XScale'</span>, <span class="string">'linear'</span>, <span class="string">'FontSize'</span>, 12);
    xlabel(<span class="string">'background luminance (cd/m2)'</span>, <span class="string">'FontSize'</span>, 14, <span class="string">'FontWeight'</span>, <span class="string">'bold'</span>);
    ylabel(<span class="string">'current modulation (pAmps)'</span>, <span class="string">'FontSize'</span>, 14, <span class="string">'FontWeight'</span>, <span class="string">'bold'</span>);
    hL = legend({<span class="string">'L'</span>, <span class="string">'M'</span>, <span class="string">'S'</span>});set(hL, <span class="string">'FontSize'</span>, 14, <span class="string">'Location'</span>, <span class="string">'NorthWest'</span>);
    grid <span class="string">on</span>; box <span class="string">on</span>;


    subplot(<span class="string">'Position'</span>, subplotPosVectors2(3,1).v);
    hold <span class="string">on</span>
    modelRegimeX = [modelRegime(1) modelRegime(1) modelRegime(2) modelRegime(2) modelRegime(1)];
    modelRegimeY = [pCurrentModulationRange(1) pCurrentModulationRange(2) pCurrentModulationRange(2) pCurrentModulationRange(1) pCurrentModulationRange(1)];
    patch(modelRegimeX, modelRegimeY, [0.83 0.83 0.63]);
    plot(modelRegimeX, modelRegimeY, <span class="string">'k--'</span>, <span class="string">'LineWidth'</span>, 1.0);
    plot(isomerizationRateModulation(:,1), photoCurrentModulation(:,1), <span class="string">'rs-'</span>, <span class="string">'LineWidth'</span>, 2.0, <span class="string">'MarkerSize'</span>, 12);
    plot(isomerizationRateModulation(:,2), photoCurrentModulation(:,2), <span class="string">'gs-'</span>, <span class="string">'LineWidth'</span>, 2.0, <span class="string">'MarkerSize'</span>, 9, <span class="string">'Color'</span>, [0 0.7 0.0]);
    plot(isomerizationRateModulation(:,3), photoCurrentModulation(:,3), <span class="string">'bs-'</span>, <span class="string">'LineWidth'</span>, 2.0, <span class="string">'MarkerSize'</span>, 6);

    set(gca, <span class="string">'XLim'</span>, [min(isomerizationRateModulation(:)) max(isomerizationRateModulation(:))],<span class="string">'FontSize'</span>, 12);
    set(gca, <span class="string">'YLim'</span>, pCurrentModulationRange);
    xlabel(<span class="string">'isomerization rate modulation (R*/cone/sec) '</span>, <span class="string">'FontSize'</span>, 14, <span class="string">'FontWeight'</span>, <span class="string">'bold'</span>);
    ylabel(<span class="string">'current modulation (pAmps)'</span>, <span class="string">'FontSize'</span>, 14, <span class="string">'FontWeight'</span>, <span class="string">'bold'</span>);
    <span class="comment">%hL = legend({'L', 'M', 'S'});set(hL, 'FontSize', 14, 'FontWeight', 'bold');</span>
    grid <span class="string">on</span>; box <span class="string">on</span>;



    coneNames = {<span class="string">'L'</span>, <span class="string">'M'</span>, <span class="string">'S'</span>};
    lumColors = jet(numel(luminancesExamined));
    <span class="keyword">for</span> coneIndex = 1:3
        <span class="keyword">for</span> osTimeStepIndex = 1:numel(osTimeSteps)
            legends = {<span class="string">'stimulus'</span>};
            subplot(<span class="string">'Position'</span>, subplotPosVectors2(coneIndex, osTimeStepIndex+1).v);

            <span class="keyword">if</span> (coneIndex == 1)
                oiTimeAxisShift = 0.028;
            <span class="keyword">elseif</span> (coneIndex == 2)
                oiTimeAxisShift = 0.024;
            <span class="keyword">else</span>
                oiTimeAxisShift = 0.021;
            <span class="keyword">end</span>
            oiTimeAxisShift = (oiTimeAxis(2)-oiTimeAxis(1))/2;
            bar(oiTimeAxis+oiTimeAxisShift, modulationFunction, 1, <span class="string">'EdgeColor'</span>, <span class="string">'none'</span>, <span class="string">'FaceColor'</span>, [0.75 0.75 0.75]);

            hold <span class="string">on</span>;
            <span class="keyword">for</span> lumIndex = 1:size(timeAxisLMSfilters,1)
                legends{numel(legends)+1} = sprintf(<span class="string">'%d cd/m2'</span>, luminancesExamined(lumIndex));
                IR = squeeze(LMSfilters(lumIndex, osTimeStepIndex, :, coneIndex));
                normFactor = max(max(abs(LMSfilters(:, osTimeStepIndex,:,coneIndex))));
                normFactor = max(IR);
                plot(squeeze(timeAxisLMSfilters(lumIndex, osTimeStepIndex,:)), IR/normFactor, <span class="string">'k-'</span>, <span class="string">'MarkerSize'</span>, 10-2*coneIndex, <span class="string">'LineWidth'</span>, 1.5, <span class="string">'Color'</span>, 0.7*squeeze(lumColors(lumIndex,:))); hold <span class="string">on</span>;
            <span class="keyword">end</span>



            plot(squeeze(timeAxisLMSfilters(lumIndex, osTimeStepIndex,:)), IR*0, <span class="string">'k-'</span>);

            hold <span class="string">off</span>;
            grid <span class="string">on</span>; box <span class="string">on</span>;

            set(gca, <span class="string">'XLim'</span>, [0 0.5], <span class="string">'YLim'</span>, [-0.2 1], <span class="string">'FontSize'</span>, 12);
            hL = legend(legends, <span class="string">'Location'</span>, <span class="string">'NorthEast'</span>);
            set(hL, <span class="string">'FontSize'</span>, 12);
            set(gca, <span class="string">'FontSize'</span>, 14);
            title(sprintf(<span class="string">'%s-cone (timeStep: %2.2f ms)'</span>, coneNames{coneIndex}, osTimeSteps(osTimeStepIndex)*1000));
            <span class="keyword">if</span> (coneIndex &lt; 3)
                set(gca, <span class="string">'XTickLabel'</span>, {});
            <span class="keyword">else</span>
                xlabel(<span class="string">'time (sec)'</span>, <span class="string">'FontWeight'</span>, <span class="string">'bold'</span>, <span class="string">'FontSize'</span>, 14);
            <span class="keyword">end</span>
            <span class="keyword">if</span> (osTimeStepIndex &gt; 1)
                set(gca, <span class="string">'YTickLabel'</span>, {});
            <span class="keyword">end</span>
        <span class="keyword">end</span>
    <span class="keyword">end</span>

<span class="keyword">end</span>


<span class="keyword">function</span> theConeMosaic = coneMosaicGenerate(mosaicSize, photonNoise, osNoise, integrationTime, osTimeStep)
    <span class="comment">% Default human mosaic</span>
    theConeMosaic = coneMosaic;

    <span class="comment">% Adjust size</span>
    <span class="keyword">if</span> isnan(mosaicSize)
        <span class="comment">% Generate a human cone mosaic with 1L, 1M and 1S cone</span>
        theConeMosaic.rows = 1;
        theConeMosaic.cols = 3;
        theConeMosaic.pattern = [2 3 4];
    <span class="keyword">else</span>
        theConeMosaic.setSizeToFOV(mosaicSize);
    <span class="keyword">end</span>

    <span class="comment">% Set the noise</span>
    theConeMosaic.noiseFlag = photonNoise;

    <span class="comment">% Set the integrationTime</span>
    theConeMosaic.integrationTime = integrationTime;

    <span class="comment">% Generate the outer-segment object to be used by the coneMosaic</span>
    theOuterSegment = osLinear();
    theOuterSegment.noiseFlag = osNoise;

    <span class="comment">% Set a custom timeStep, for @osLinear we do not need the default 0.1 msec</span>
    theOuterSegment.timeStep = osTimeStep;

    <span class="comment">% Couple the outersegment object to the cone mosaic object</span>
    theConeMosaic.os = theOuterSegment;
<span class="keyword">end</span>

<span class="keyword">function</span> theOI = oiGenerate(noOptics)
    <span class="comment">% Generate optics</span>
    <span class="keyword">if</span> (noOptics)
        theOI = oiCreate(<span class="string">'diffraction limited'</span>);
        optics = oiGet(theOI,<span class="string">'optics'</span>);
        optics = opticsSet(optics,<span class="string">'fnumber'</span>,0);
        optics = opticsSet(optics, <span class="string">'off axis method'</span>, <span class="string">'skip'</span>);
        theOI = oiSet(theOI,<span class="string">'optics'</span>, optics);
    <span class="keyword">else</span>
        theOI = oiCreate(<span class="string">'human'</span>);
    <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="keyword">function</span> uniformScene = uniformFieldSceneCreate(FOV, meanLuminance)
    uniformScene = sceneCreate(<span class="string">'uniform equal photon'</span>, 128);
    <span class="comment">% square scene with desired FOV</span>
    uniformScene = sceneSet(uniformScene, <span class="string">'wAngular'</span>, FOV);
    <span class="comment">% 1 meter away</span>
    uniformScene = sceneSet(uniformScene, <span class="string">'distance'</span>, 1.0);
    <span class="comment">% adjust radiance according to desired  mean luminance</span>
    uniformScene = sceneAdjustLuminance(uniformScene, meanLuminance);
<span class="keyword">end</span>
</pre><pre class="codeoutput">No current noise added.
No current noise added.
No current noise added.
No current noise added.
No current noise added.
No current noise added.
No current noise added.
No current noise added.
No current noise added.
No current noise added.
No current noise added.
No current noise added.
No current noise added.
No current noise added.
No current noise added.
No current noise added.
No current noise added.
No current noise added.
No current noise added.
No current noise added.
No current noise added.
No current noise added.
No current noise added.
No current noise added.
No current noise added.
No current noise added.
No current noise added.
No current noise added.
No current noise added.
No current noise added.
No current noise added.
No current noise added.
No current noise added.
No current noise added.
No current noise added.
No current noise added.
No current noise added.
No current noise added.
No current noise added.
No current noise added.
</pre><img vspace="5" hspace="5" src="t_osCurrentsVsLuminanceLevel_01.png" style="width:1800px;height:1200px;" alt=""> <img vspace="5" hspace="5" src="t_osCurrentsVsLuminanceLevel_02.png" style="width:4096px;height:1007px;" alt=""> <p class="footer"><br><a href="http://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2016a</a><br></p></div><!--
##### SOURCE BEGIN #####
function t_osCurrentsVsLuminanceLevel

    % Define the time axis for the simulation
    stimulusSamplingInterval = 1/1000;             % 50/1000
    oiTimeAxis = 0:stimulusSamplingInterval:0.3;   % 2.0
    oiTimeAxis = oiTimeAxis - mean(oiTimeAxis);
    
    % Compute the stimulus modulation function
    stimulusRampTau = 5/1000;  % 0.18;
    modulationGain = 1.0;
    modulationFunction = modulationGain * exp(-0.5*(oiTimeAxis/stimulusRampTau).^2);
    
    % Generate optics
    noOptics = false;
    theOI = oiGenerate(noOptics);
    
    % Background luminance levels to be examined
    luminancesExamined = [50:50:1000]; %  1500 2000 3000];

    % Outer segment time steps to be examined
    osTimeSteps = [0.1]/1000;

    % Generate a number of oiSequences, one for each luminance examined
    for lumIndex = 1:numel(luminancesExamined)
        % Generate the scene
        FOV = 1.0;
        theScene = uniformFieldSceneCreate(FOV, luminancesExamined(lumIndex));

        % Compute the optical images
        oiBackground = oiCompute(theOI, theScene);
        oiModulated  = oiBackground;
    
        % Generate the sequence of optical images
        pos = oiGet(oiBackground, 'spatial support', 'microns');
        modulationRegion.radiusInMicrons = 0.5*max(pos(:));
        theOIsequenceArray{lumIndex} = oiSequence(oiBackground, oiModulated, oiTimeAxis, modulationFunction, 'modulationRegion', modulationRegion);
        %theOIsequence.visualize('format', 'montage');
    end % lumIndex
    
    
    % Generate a cone mosaic with 1 L-, 1 M-, and 1 S-cone only
    mosaicSize =  nan;                    
    integrationTime = 1/1000;            
    photonNoise = 'none';                     
    osTimeStep = 1/1000;                    
    osNoise = 'none';                        
    theConeMosaic = coneMosaicGenerate(mosaicSize, photonNoise, osNoise, integrationTime, osTimeStep);
    
    % Generate eye movement path
    eyeMovementsNum = theOIsequenceArray{1}.maxEyeMovementsNumGivenIntegrationTime(theConeMosaic.integrationTime);
    instancesNum = 1;
    emPaths = zeros(instancesNum, eyeMovementsNum,2);
    for instanceIndex = 1:instancesNum
        emPaths(instanceIndex, :, :) = theConeMosaic.emGenSequence(eyeMovementsNum)*0;
    end 

    
    hFig = figure(1); clf;
    set(hFig, 'Position', [10 10 1800 1200]);
     

    subplotPosVectors = NicePlot.getSubPlotPosVectors(...
           'rowsNum', numel(luminancesExamined), ...
           'colsNum', numel(osTimeSteps)+1, ...
           'heightMargin',   0.02, ...
           'widthMargin',    0.02, ...
           'leftMargin',     0.03, ...
           'rightMargin',    0.00, ...
           'bottomMargin',   0.03, ...
           'topMargin',      0.01);
      
    subplotPosVectors2 = NicePlot.getSubPlotPosVectors(...
           'rowsNum', 3, ...
           'colsNum', 1+numel(osTimeSteps), ...
           'heightMargin',   0.08, ...
           'widthMargin',    0.07, ...
           'leftMargin',     0.08, ...
           'rightMargin',    0.00, ...
           'bottomMargin',   0.04, ...
           'topMargin',      0.01);
       
    isomerizationsRange =  [0 200];
    luminanceRange = [0 1100];
    luminanceTicks = [0:200:1100];
    pCurrentRange = [-85 0];
    pCurrentModulationRange = [0 30];
    
    for lumIndex = 1: numel(luminancesExamined) 
        for osTimeStepIndex = 0:numel(osTimeSteps)
            if (osTimeStepIndex > 0)
                theConeMosaic.os.timeStep = osTimeSteps(osTimeStepIndex);
            end

            [isomerizations, photocurrents, tmpLMSfilters] = ...
                theConeMosaic.computeForOISequence(theOIsequenceArray{lumIndex}, ...
                'emPaths', emPaths, ...
                'currentFlag', true);

            
            timeAxis = theConeMosaic.timeAxis + theOIsequenceArray{lumIndex}.timeAxis(1);
            timeRange = [timeAxis(1) timeAxis(end)];
            timeRange = [-500 500]/1000;
    
            if (lumIndex == 1) && (osTimeStepIndex == 1)
                LMSfilters = zeros(numel(luminancesExamined), numel(osTimeSteps), size(tmpLMSfilters,1), size(tmpLMSfilters,2));
            end
            if (osTimeStepIndex > 0)
               LMSfilters(lumIndex, osTimeStepIndex, :,:) = tmpLMSfilters;
               timeAxisLMSfilters(lumIndex, osTimeStepIndex,:) = (1:size(tmpLMSfilters,1)) * (timeAxis(2)-timeAxis(1));
            end
            
            % Plot the isomerization signals
            if (osTimeStepIndex == 0)
                figure(hFig);
                subplot('Position', subplotPosVectors(lumIndex, 1).v);
                plot(timeAxis, squeeze(isomerizations(1,1,1,:)), 'r-', 'LineWidth', 1.5);
                hold on;
                plot(timeAxis, squeeze(isomerizations(1,1,2,:)), 'g-', 'LineWidth', 1.5);
                plot(timeAxis, squeeze(isomerizations(1,1,3,:)), 'b-', 'LineWidth', 1.5);
                set(gca, 'XLim', timeRange);
                title(sprintf('background lum: %d cd/m2', luminancesExamined(lumIndex)));
                ylabel(sprintf('absorptions / %d ms', theConeMosaic.integrationTime*1000), 'FontSize', 12);
                set(gca, 'YLim', isomerizationsRange, 'FontSize', 12);
                
                if (lumIndex <  numel(luminancesExamined))
                    set(gca, 'XTickLabel', {});
                else
                    xlabel('time (ms)', 'FontSize', 12);
                end
                grid on; box on;
                drawnow;
                
            % Plot the photocurrent signals
            else
                figure(hFig);
                subplot('Position', subplotPosVectors(lumIndex, osTimeStepIndex+1).v);
                plot(timeAxis, squeeze(photocurrents(1,1,1,:)), 'r-', 'LineWidth', 1.5);
                hold on;
                plot(timeAxis, squeeze(photocurrents(1,1,2,:)), 'g-', 'LineWidth', 1.5);
                plot(timeAxis, squeeze(photocurrents(1,1,3,:)), 'b-', 'LineWidth', 1.5);
                set(gca, 'XLim', timeRange);
                title(sprintf('os.timeStep = %2.3f ms', theConeMosaic.os.timeStep*1000));
                if (osTimeStepIndex == 1)
                    ylabel('current (pAmps)');
                end
                set(gca, 'YLim', pCurrentRange);
                
                if (osTimeStepIndex > 1)
                    set(gca, 'YTickLabel', {});
                end
                
                if (lumIndex == numel(luminancesExamined))
                    xlabel('time (seconds)');
                else
                    set(gca, 'XTickLabel', {});
                end
                set(gca, 'FontSize', 10);
                grid on; box on;
                drawnow;
            end        
            
            
            if (osTimeStepIndex == 1)
                % Compute modulation of photocurrents at different background luminance levels
                
                for coneIndex = 1:3
                    photocurrent = squeeze(photocurrents(1,1,coneIndex,:));
                    isomerizationRate = squeeze(isomerizations(1,1,coneIndex,:)) / theConeMosaic.integrationTime;
                    baselineP = photocurrent(end);
                    baselineIR = isomerizationRate(end);
                    if (baselineP < 0)
                        deltaPhotocurrent = max(photocurrent(:)) - baselineP;
                    else
                        deltaPhotocurrent = 0;
                    end
                    photoCurrentModulation(lumIndex,coneIndex) = deltaPhotocurrent;
                    isomerizationRateModulation(lumIndex,coneIndex) = max(isomerizationRate(:))-baselineIR;
                end % coneIndex
            end
                
        end % osTimeStepIndex
    end % lumIndex
    

    hFig2 = figure(2); clf;
    set(hFig2, 'Position', [10 10 900 1290], 'Color', [1 1 1]);
    
    modelRegime = [500 20000];
    modelRegimeY = [modelRegime(1) modelRegime(1) modelRegime(2) modelRegime(2) modelRegime(1)];
    modelRegimeX = [luminanceRange(1) luminanceRange(2) luminanceRange(2) luminanceRange(1) pCurrentModulationRange(1)];
    
    subplot('Position', subplotPosVectors2(1,1).v);
    hold on
    patch(modelRegimeX, modelRegimeY, [0.83 0.83 0.63]);
    plot(modelRegimeX, modelRegimeY, 'kREPLACE_WITH_DASH_DASH', 'LineWidth', 1.0);
    plot(luminancesExamined, isomerizationRateModulation(:,1), 'rs-', 'MarkerFaceColor', [0.8 0.8 0.8], 'LineWidth', 2.0, 'MarkerSize', 12); 
    plot(luminancesExamined, isomerizationRateModulation(:,2), 'gs-', 'MarkerFaceColor', [0.6 0.6 0.6], 'LineWidth', 2.0, 'MarkerSize', 12);
    plot(luminancesExamined, isomerizationRateModulation(:,3), 'bs-', 'MarkerFaceColor', [0.8 0.8 0.8], 'LineWidth', 2.0, 'MarkerSize', 12);
    
    set(gca, 'FontSize', 14, 'XLim', luminanceRange, 'XTick', luminanceTicks, 'XScale', 'linear', 'FontSize', 12);
    xlabel('background luminance (cd/m2)', 'FontSize', 14, 'FontWeight', 'bold');
    ylabel('isomerization rate modulation (R*/cone/sec)', 'FontSize', 14, 'FontWeight', 'bold');
    %hL = legend({'L', 'M', 'S'});set(hL, 'FontSize', 14, 'Location', 'NorthWest');
    grid on; box on;
    

    subplot('Position', subplotPosVectors2(2,1).v);
    hold on
    plot(luminancesExamined, photoCurrentModulation(:,1), 'rs-', 'MarkerFaceColor', [0.8 0.8 0.8], 'LineWidth', 2.0, 'MarkerSize', 12); 
    plot(luminancesExamined, photoCurrentModulation(:,2), 'gs-', 'MarkerFaceColor', [0.6 0.6 0.6], 'LineWidth', 2.0, 'MarkerSize', 12);
    plot(luminancesExamined, photoCurrentModulation(:,3), 'bs-', 'MarkerFaceColor', [0.8 0.8 0.8], 'LineWidth', 2.0, 'MarkerSize', 12);

    set(gca, 'FontSize', 14, 'XLim', luminanceRange, 'YLim', pCurrentModulationRange, 'XTick', luminanceTicks, 'XScale', 'linear', 'FontSize', 12);
    xlabel('background luminance (cd/m2)', 'FontSize', 14, 'FontWeight', 'bold');
    ylabel('current modulation (pAmps)', 'FontSize', 14, 'FontWeight', 'bold');
    hL = legend({'L', 'M', 'S'});set(hL, 'FontSize', 14, 'Location', 'NorthWest');
    grid on; box on;
    
    
    subplot('Position', subplotPosVectors2(3,1).v);
    hold on
    modelRegimeX = [modelRegime(1) modelRegime(1) modelRegime(2) modelRegime(2) modelRegime(1)];
    modelRegimeY = [pCurrentModulationRange(1) pCurrentModulationRange(2) pCurrentModulationRange(2) pCurrentModulationRange(1) pCurrentModulationRange(1)];
    patch(modelRegimeX, modelRegimeY, [0.83 0.83 0.63]);
    plot(modelRegimeX, modelRegimeY, 'kREPLACE_WITH_DASH_DASH', 'LineWidth', 1.0);
    plot(isomerizationRateModulation(:,1), photoCurrentModulation(:,1), 'rs-', 'LineWidth', 2.0, 'MarkerSize', 12); 
    plot(isomerizationRateModulation(:,2), photoCurrentModulation(:,2), 'gs-', 'LineWidth', 2.0, 'MarkerSize', 9, 'Color', [0 0.7 0.0]);
    plot(isomerizationRateModulation(:,3), photoCurrentModulation(:,3), 'bs-', 'LineWidth', 2.0, 'MarkerSize', 6);
    
    set(gca, 'XLim', [min(isomerizationRateModulation(:)) max(isomerizationRateModulation(:))],'FontSize', 12);
    set(gca, 'YLim', pCurrentModulationRange);
    xlabel('isomerization rate modulation (R*/cone/sec) ', 'FontSize', 14, 'FontWeight', 'bold');
    ylabel('current modulation (pAmps)', 'FontSize', 14, 'FontWeight', 'bold');
    %hL = legend({'L', 'M', 'S'});set(hL, 'FontSize', 14, 'FontWeight', 'bold');
    grid on; box on;
    
    

    coneNames = {'L', 'M', 'S'};
    lumColors = jet(numel(luminancesExamined));
    for coneIndex = 1:3
        for osTimeStepIndex = 1:numel(osTimeSteps)
            legends = {'stimulus'};
            subplot('Position', subplotPosVectors2(coneIndex, osTimeStepIndex+1).v);
            
            if (coneIndex == 1)
                oiTimeAxisShift = 0.028;
            elseif (coneIndex == 2)
                oiTimeAxisShift = 0.024;
            else
                oiTimeAxisShift = 0.021;
            end
            oiTimeAxisShift = (oiTimeAxis(2)-oiTimeAxis(1))/2;
            bar(oiTimeAxis+oiTimeAxisShift, modulationFunction, 1, 'EdgeColor', 'none', 'FaceColor', [0.75 0.75 0.75]);
            
            hold on;
            for lumIndex = 1:size(timeAxisLMSfilters,1)
                legends{numel(legends)+1} = sprintf('%d cd/m2', luminancesExamined(lumIndex));
                IR = squeeze(LMSfilters(lumIndex, osTimeStepIndex, :, coneIndex));
                normFactor = max(max(abs(LMSfilters(:, osTimeStepIndex,:,coneIndex))));
                normFactor = max(IR);
                plot(squeeze(timeAxisLMSfilters(lumIndex, osTimeStepIndex,:)), IR/normFactor, 'k-', 'MarkerSize', 10-2*coneIndex, 'LineWidth', 1.5, 'Color', 0.7*squeeze(lumColors(lumIndex,:))); hold on;
            end
            
            
            
            plot(squeeze(timeAxisLMSfilters(lumIndex, osTimeStepIndex,:)), IR*0, 'k-');
            
            hold off;
            grid on; box on;
            
            set(gca, 'XLim', [0 0.5], 'YLim', [-0.2 1], 'FontSize', 12);
            hL = legend(legends, 'Location', 'NorthEast');
            set(hL, 'FontSize', 12);
            set(gca, 'FontSize', 14);
            title(sprintf('%s-cone (timeStep: %2.2f ms)', coneNames{coneIndex}, osTimeSteps(osTimeStepIndex)*1000));
            if (coneIndex < 3)
                set(gca, 'XTickLabel', {});
            else
                xlabel('time (sec)', 'FontWeight', 'bold', 'FontSize', 14);
            end
            if (osTimeStepIndex > 1)
                set(gca, 'YTickLabel', {});
            end
        end
    end
        
end


function theConeMosaic = coneMosaicGenerate(mosaicSize, photonNoise, osNoise, integrationTime, osTimeStep)
    % Default human mosaic
    theConeMosaic = coneMosaic;
    
    % Adjust size
    if isnan(mosaicSize)
        % Generate a human cone mosaic with 1L, 1M and 1S cone
        theConeMosaic.rows = 1;
        theConeMosaic.cols = 3;
        theConeMosaic.pattern = [2 3 4];
    else
        theConeMosaic.setSizeToFOV(mosaicSize);
    end
    
    % Set the noise
    theConeMosaic.noiseFlag = photonNoise;

    % Set the integrationTime
    theConeMosaic.integrationTime = integrationTime;
    
    % Generate the outer-segment object to be used by the coneMosaic
    theOuterSegment = osLinear();
    theOuterSegment.noiseFlag = osNoise;
    
    % Set a custom timeStep, for @osLinear we do not need the default 0.1 msec
    theOuterSegment.timeStep = osTimeStep;

    % Couple the outersegment object to the cone mosaic object
    theConeMosaic.os = theOuterSegment;
end

function theOI = oiGenerate(noOptics)
    % Generate optics
    if (noOptics)
        theOI = oiCreate('diffraction limited');
        optics = oiGet(theOI,'optics');           
        optics = opticsSet(optics,'fnumber',0);
        optics = opticsSet(optics, 'off axis method', 'skip');
        theOI = oiSet(theOI,'optics', optics);
    else
        theOI = oiCreate('human');
    end
end

function uniformScene = uniformFieldSceneCreate(FOV, meanLuminance)
    uniformScene = sceneCreate('uniform equal photon', 128);
    % square scene with desired FOV
    uniformScene = sceneSet(uniformScene, 'wAngular', FOV);
    % 1 meter away
    uniformScene = sceneSet(uniformScene, 'distance', 1.0);
    % adjust radiance according to desired  mean luminance
    uniformScene = sceneAdjustLuminance(uniformScene, meanLuminance);
end
##### SOURCE END #####
--></body></html>